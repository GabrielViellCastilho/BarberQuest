<!doctype html>
<html lang="pt">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BarberQuest</title>
  <link rel="shortcut icon" type="image/png" href="static/images/logo.png">
  <link rel="stylesheet" href="static/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{.CSS}}">
</head>

<body>

<nav class="navbar navbar-expand-lg primaryColor sticky-top" data-bs-theme="dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="static/images/logo.png" alt="logo" width="80cm" height="80cm">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse " id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0 custom-spacing">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="/">Home</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link active" aria-current="page" href="/appointment">Agendar</a>
        </li>
      </ul>
      <center>
        <button id="loginButton" type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalLogin">Login</button>

        <button id="profileButton" class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample" style="display: none">
          Perfil
        </button>

      </center>
      </strong>
    </div>
  </div>

</nav>
<div class="main-content">
<div class="container mt-5">
  <div class="primaryColor rounded">
  <h2 class="text-center">Perfil do Usuário</h2></div>
  <div class="card p-4 shadow-sm primaryColor text-light">
    <form id="userForm">
      <div class="mb-3">
        <label for="showEmail" class="form-label">E-mail</label>
        <input type="email" id="showEmail" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label for="showName" class="form-label">Nome</label>
        <input type="text" id="showName" class="form-control" required minlength="4" maxlength="100">
      </div>
      <div class="mb-3">
        <label for="cellphone" class="form-label">Celular</label>
        <input type="text" id="cellphone" name="cellphone" class="form-control" required minlength="15" maxlength="15" oninput="formatCellphone(this)">
      </div>
      <button type="submit" class="btn btn-success w-100">Atualizar</button>
    </form>
    <br>
    <button type="button" class="btn btn-danger w-100" id="deleteUserButton">Excluir conta</button>
  </div>
</div></div>
<div id="footer-container" class="mt-3"></div>


<script>
  const jwtToken = localStorage.getItem("jwt_token");

  async function fetchUserData() {
    try {
      const response = await fetch(`/getMyUserData`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${jwtToken}`,
          "Content-Type": "application/json"
        }
      });
      if (!response.ok) {
       if (response.status===401){
         showAlert("Sessão expirada")
         setTimeout(logout,3000)
         return
       }
        throw new Error("Erro ao buscar dados");}
      const data = await response.json();

      const formattedCellphone = formatCellphoneInput(data.cellphone);


      document.getElementById("showEmail").value = data.email;
      document.getElementById("showName").value = data.name;
      document.getElementById("cellphone").value = formattedCellphone;
    } catch (error) {
      console.error(error);
    }
  }

  document.getElementById("userForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    const updatedData = {
      name: document.getElementById("showName").value,
      cellphone: getOnlyNumbers(document.getElementById("cellphone").value)
    };
    try {
      const response = await fetch(`/updateMyUser`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${jwtToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(updatedData)
      });
      if (!response.ok) throw new Error("Erro ao atualizar");
      showAlert("Dados atualizados com sucesso!");
      fetchUserData();
    } catch (error) {
      console.error(error);
      showAlert("Erro ao atualizar informações.");
    }
  });

  fetchUserData();

  async function deleteUser() {
    const token = localStorage.getItem("jwt_token");
    if (!token) {
      showAlert("Usuário não autenticado!");
      return;
    }

    try {
      const response = await fetch("/deleteMyUser", {
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (response.ok) {
        showAlert("Usuário deletado com sucesso!","success");
        localStorage.removeItem("jwt-token");
        logout()
      } else {
        showAlert("Erro ao deletar usuário!");
      }
    } catch (error) {
      console.error("Erro ao deletar usuário:", error);
      showAlert("Erro ao conectar com o servidor.");
    }
  }

  document.getElementById("deleteUserButton").addEventListener("click", function() {
    showConfirm(
            "Excluir Conta",
            "Tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita!",
            deleteUser
    );
  });

  function formatCellphone(input) {
    let cellphone = input.value.replace(/\D/g, '');

    if (cellphone.length > 2) {
      cellphone = `(${cellphone.substring(0, 2)}) ${cellphone.substring(2)}`;
    }
    if (cellphone.length > 10) {
      cellphone = `${cellphone.substring(0, 10)}-${cellphone.substring(10, 15)}`;
    }

    input.value = cellphone;
  }


</script>

<script src="static/bootstrap/js/bootstrap.bundle.min.js" defer></script>
<script src="{{.JS}}" defer></script>
</body>

<div id="modals-placeholder"></div>

<!-- Offcanvas para Usuário Comum -->
<div class="offcanvas offcanvas-start primaryColor" data-bs-theme="dark" tabindex="-1" id="offcanvasUser"
     aria-labelledby="offcanvasExampleLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Perfil</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <center>
      <a style="font-size:130%" href="/myProfile" class="link-light "><img
                src="static/images/usuario-de-perfil.png" class="me-3">Meu perfil</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/myAppointments" class="link-light "><img
                src="static/images/time-and-calendar.png" class="me-3">Meus agendamentos</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/myHistoric" class="link-light "><img src="static/images/relogio.png"
                                                                            class="me-3">Meu histórico</a>
      <br>
      <hr>
      <button id="logoutButton" type="button" class="btn btn-outline-danger" onclick="logout()">Sair</button>
    </center>
  </div>
</div>

<!-- Offcanvas para Barbeiro -->
<div class="offcanvas offcanvas-start primaryColor" data-bs-theme="dark" tabindex="-1" id="offcanvasBarber"
     aria-labelledby="offcanvasExampleLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Perfil</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <center>
      <a style="font-size:130%" href="/myProfile" class="link-light "><img
                src="static/images/usuario-de-perfil.png" class="me-3">Meu perfil</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/myAppointmentsBarber" class="link-light "><img
                src="static/images/time-and-calendar.png" class="me-3">Meus agendamentos</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/inPersonAppointments" class="link-light "><img
                src="static/images/relogio.png" class="me-3">Agendamento presencial</a>
      <br>
      <hr>
      <a style="font-size: 130%" href="/barberAvailability" class="link-light"><img
                src="static/images/hair-salon.png" class="me-3">Período de serviço</a>
      <br>
      <hr>
      <a style="font-size: 130%" href="/barberSpecialSchedule" class="link-light"><img
                src="static/images/compromisso.png" class="me-3">Disponibilidade Especial</a>
      <br>
      <hr>
      <button id="logoutButton" type="button" class="btn btn-outline-danger" onclick="logout()">Sair</button>
    </center>
  </div>
</div>

<!-- Offcanvas para Administrador -->
<div class="offcanvas offcanvas-start primaryColor" id="offcanvasAdmin" tabindex="-1" aria-labelledby="offcanvasAdminLabel"
     data-bs-theme="dark">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasAdminLabel">Painel do Administrador</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <center>
      <a style="font-size:130%" href="/myProfile" class="link-light "><img
                src="static/images/usuario-de-perfil.png" class="me-3">Meu perfil</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/inPersonAppointments" class="link-light "><img
                src="static/images/relogio.png" class="me-3">Agendamento presencial</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/appointmentAllBarbers" class="link-light "><img
                src="static/images/compromisso.png" class="me-3">Agendamento dos barbeiros</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/service" class="link-light "><img
                src="static/images/Designer.png" style="width: 32px" class="me-3">Serviços</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/birthdaysOfTheDay" class="link-light "><img
                src="static/images/birthday-and-party.png" style="width: 32px" class="me-3">Aniversariantes</a>
      <br>
      <hr>
      <button id="logoutButton" type="button" class="btn btn-outline-danger" onclick="logout()">Sair</button>
    </center>
  </div>
</div>



<style>
  html, body {
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
  }
</style>
</html>