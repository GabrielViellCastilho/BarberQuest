<!doctype html>
<html lang="pt">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BarberQuest</title>
  <link rel="shortcut icon" type="image/png" href="static/images/logo.png">
  <link rel="stylesheet" href="static/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{.CSS}}">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script> <!-- Tradução para português -->

</head>

<body>

<nav class="navbar navbar-expand-lg primaryColor sticky-top" data-bs-theme="dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="static/images/logo.png" alt="logo" width="80cm" height="80cm">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse " id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0 custom-spacing">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="/">Home</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link active" aria-current="page" href="/appointment">Agendar</a>
        </li>
      </ul>
      <center>
        <button id="loginButton" type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalLogin">Login</button>

        <button id="profileButton" class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample" style="display: none">
          Perfil
        </button>

      </center>
      </strong>
    </div>
  </div>

</nav>

<br>
<div class="main-content">
  <div class="container primaryColor shadow-lg rounded-4 p-5 mt-5" style="max-width: 600px;">
    <h2 class="text-center mb-4 fw-bold ">Agendamento</h2>

    <form id="appointmentForm" action="/submit-appointment" method="POST">
      <!--Campo Nome -->
      <div class="mb-4">
        <label for="name" class="form-label fw-semibold">Nome</label>
        <input type="text" id="name" class="form-control p-3 rounded-3" placeholder="Insira o nome do cliente" required>
      </div>

      <!--Campo Celular -->
      <div class="mb-4">
        <label for="phone" class="form-label fw-semibold">Celular</label>
        <input type="text" class="form-control rounded-3" id="phone" placeholder="(XX) XXXXX-XXXX" maxlength="15" required>
      </div>

      <!-- Campo Data -->
      <div class="mb-4">
        <label for="datePicker" class="form-label fw-semibold">Data do agendamento</label>
        <input type="text" id="datePicker" class="form-control p-3 rounded-3" placeholder="Selecione uma data" required>
      </div>

      <!-- Campo Barbeiro -->
      <div class="mb-4">
        <label for="barbeiro" class="form-label fw-semibold">Selecione seu barbeiro</label>
        <select class="form-select p-3 rounded-3" id="barbeiro" required>
          <option value="" disabled selected>Escolha um barbeiro</option>
        </select>
      </div>

      <!-- Campo Serviço -->
      <div class="mb-4">
        <label for="servico" class="form-label fw-semibold">Selecione seu serviço</label>
        <select class="form-select p-3 rounded-3" id="servico" required>
          <option value="" disabled selected>Escolha um serviço</option>
        </select>
      </div>

      <!-- Contêiner de horários disponíveis -->
      <div class="mb-3 d-none" id="containerHour">
        <label class="form-label">Horários disponíveis</label>
        <div id="availableSlots" class="d-flex overflow-auto rounded-2">
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-success btn-lg px-5 rounded-pill shadow-sm">Confirmar Agendamento</button>
      </div>
    </form>
  </div>
  <br>
</div>
<div id="footer-container"></div>
<script src="static/bootstrap/js/bootstrap.bundle.min.js" defer></script>
<script src="{{.JS}}" defer></script>
</body>

<div id="modals-placeholder"></div>

<!-- Offcanvas para Usuário Comum -->
<div class="offcanvas offcanvas-start primaryColor" data-bs-theme="dark" tabindex="-1" id="offcanvasUser"
     aria-labelledby="offcanvasExampleLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Perfil</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <center>
      <a style="font-size:130%" href="/myProfile" class="link-light "><img
                src="static/images/usuario-de-perfil.png" class="me-3">Meu perfil</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/myAppointments" class="link-light "><img
                src="static/images/time-and-calendar.png" class="me-3">Meus agendamentos</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/myHistoric" class="link-light "><img src="static/images/relogio.png"
                                                                            class="me-3">Meu histórico</a>
      <br>
      <hr>
      <button id="logoutButton" type="button" class="btn btn-outline-danger" onclick="logout()">Sair</button>
    </center>
  </div>
</div>

<!-- Offcanvas para Barbeiro -->
<div class="offcanvas offcanvas-start primaryColor" data-bs-theme="dark" tabindex="-1" id="offcanvasBarber"
     aria-labelledby="offcanvasExampleLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Perfil</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <center>
      <a style="font-size:130%" href="/myProfile" class="link-light "><img
                src="static/images/usuario-de-perfil.png" class="me-3">Meu perfil</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/myAppointmentsBarber" class="link-light "><img
                src="static/images/time-and-calendar.png" class="me-3">Meus agendamentos</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/inPersonAppointments" class="link-light "><img
                src="static/images/relogio.png" class="me-3">Agendamento presencial</a>
      <br>
      <hr>
      <a style="font-size: 130%" href="/barberAvailability" class="link-light"><img
                src="static/images/hair-salon.png" class="me-3">Período de serviço</a>
      <br>
      <hr>
      <a style="font-size: 130%" href="/barberSpecialSchedule" class="link-light"><img
                src="static/images/compromisso.png" class="me-3">Disponibilidade Especial</a>
      <br>
      <hr>
      <button id="logoutButton" type="button" class="btn btn-outline-danger" onclick="logout()">Sair</button>
    </center>
  </div>
</div>

<!-- Offcanvas para Administrador -->
<div class="offcanvas offcanvas-start primaryColor" id="offcanvasAdmin" tabindex="-1" aria-labelledby="offcanvasAdminLabel"
     data-bs-theme="dark">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasAdminLabel">Painel do Administrador</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <center>
      <a style="font-size:130%" href="/myProfile" class="link-light "><img
                src="static/images/usuario-de-perfil.png" class="me-3">Meu perfil</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/inPersonAppointments" class="link-light "><img
                src="static/images/relogio.png" class="me-3">Agendamento presencial</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/appointmentAllBarbers" class="link-light "><img
                src="static/images/compromisso.png" class="me-3">Agendamento dos barbeiros</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/service" class="link-light "><img
                src="static/images/Designer.png" style="width: 32px" class="me-3">Serviços</a>
      <br>
      <hr>
      <a style="font-size:130%" href="/birthdaysOfTheDay" class="link-light "><img
                src="static/images/birthday-and-party.png" style="width: 32px" class="me-3">Aniversariantes</a>
      <br>
      <hr>
      <button id="logoutButton" type="button" class="btn btn-outline-danger" onclick="logout()">Sair</button>
    </center>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    function fetchDataWithDelay(url, callback, delay) {
      setTimeout(function () {
        fetch(url)
                .then(response => response.json())
                .then(callback)
                .catch(error => console.error("Erro ao buscar dados:", error));
      }, delay);
    }
    
    fetchDataWithDelay("/getAllAvailableService", function(data) {
      const selectServico = document.getElementById("servico");
      isTokenExpired()

      data.forEach(service => {
        let option = document.createElement("option");
        option.value = service.ID;
        option.textContent = `${service.name} - R$${service.price.toFixed(2)} (${service.duration_minutes} min)`;
        selectServico.appendChild(option);
      });
    }, 500);

    fetchDataWithDelay("/getAllBarbers", function(data) {
      const selectBarbeiro = document.getElementById("barbeiro");

      data.forEach(barber => {
        let option = document.createElement("option");
        option.value = barber.ID;
        option.textContent = barber.name;
        selectBarbeiro.appendChild(option);
      });
    }, 1000);

    function fetchAvailableSlots(barberId, serviceId, date) {
      const formattedDate = formatDate(date);
      const selectedDate = new Date(formattedDate);

      if (isNaN(selectedDate)) {
        console.error("Data inválida:", date);
        return;
      }

      const year = selectedDate.getFullYear();
      const month = String(selectedDate.getMonth() + 1).padStart(2, "0");
      const day = String(selectedDate.getDate() + 1).padStart(2, "0");

      const finalFormattedDate = `${year}-${month}-${day}`;
      console.log(`Data formatada para API: ${finalFormattedDate}`);

      const url = `/checkAvailableSlots/${barberId}/${serviceId}/${finalFormattedDate}`;
      console.log(`URL gerada: ${url}`);

      fetch(url)
              .then((response) => {
                if (response.status === 404) {
                  console.log(response.status);
                  displayNoSlotsMessage();
                  return Promise.resolve(null);
                }

                return response.json();
              })
              .then((data) => {
                const slotsContainer = document.getElementById("availableSlots");
                slotsContainer.innerHTML = "";

                let hasAvailableSlots = false;

                if (!data || data.length === 0) {
                  displayNoSlotsMessage();
                  return;
                }

                const containerHour = document.getElementById("containerHour");
                containerHour.classList.remove("d-none");

                data.forEach((slot) => {
                  if (slot.is_available) {
                    hasAvailableSlots = true;

                    const card = document.createElement("div");
                    card.classList.add("slot-card");

                    const slotTime = new Date(slot.slot);
                    slotTime.setHours(slotTime.getHours() + 2);
                    const localTime = slotTime.toLocaleString("pt-BR", {
                      timeZone: "America/Sao_Paulo",
                      hour: "2-digit",
                      minute: "2-digit",
                    });

                    card.innerHTML = `
            <span>${localTime}</span>
            <p style="color: white">Disponível</p>
          `;

                    card.addEventListener("click", function () {
                      document
                              .querySelectorAll(".slot-card")
                              .forEach((c) => c.classList.remove("selected"));
                      card.classList.add("selected");

                      console.log(`Você escolheu o horário: ${localTime}`);
                    });

                    slotsContainer.appendChild(card);
                  }
                });


                if (!hasAvailableSlots) {
                  displayNoSlotsMessage();
                }
              })
              .catch((error) => {
                console.error("Erro ao buscar horários:", error);
                displayNoSlotsMessage();
              });
    }

    function displayNoSlotsMessage() {
      const containerHour = document.getElementById("containerHour");
      containerHour.classList.remove("d-none");

      const slotsContainer = document.getElementById("availableSlots");
      slotsContainer.innerHTML =
              "<p style='color: #0a3622'>Nenhum horário disponível.</p>";
    }


    document.getElementById("barbeiro").addEventListener("change", updateAvailableSlots);
    document.getElementById("servico").addEventListener("change", updateAvailableSlots);
    document.getElementById("datePicker").addEventListener("change", updateAvailableSlots);

    function updateAvailableSlots() {
      const barberId = document.getElementById("barbeiro").value;
      const serviceId = document.getElementById("servico").value;
      const date = document.getElementById("datePicker").value;

      console.log(`Barbeiro: ${barberId}, Serviço: ${serviceId}, Data: ${date}`);

      if (barberId && serviceId && date) {
        fetchAvailableSlots(barberId, serviceId, date);
      }
    }
  });


  function formatDate(date) {
    const parts = date.split('/');
    return `${parts[2]}-${parts[1]}-${parts[0]}`;
  }

  document.getElementById("appointmentForm").addEventListener("submit", function(event) {
    event.preventDefault();

    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value.replace(/\D/g, '');
    const barberId = document.getElementById("barbeiro").value;
    const serviceId = document.getElementById("servico").value;
    const selectedDate = document.getElementById("datePicker").value;
    const selectedTime = document.querySelector(".slot-card.selected span")?.textContent;

    if (!name||!barberId || !serviceId || !selectedDate || !selectedTime) {
      alert("Por favor, preencha todos os campos e selecione um horário.");
      return;
    }

    const [day, month, year] = selectedDate.split("/");
    const formattedDate = `${year}-${month}-${day}`;
    const appointmentDateTime = `${formattedDate}T${selectedTime}:00-03:00`;

    if (isTokenExpired()) {
      const modal = new bootstrap.Modal(document.getElementById("modalLogin"));
      modal.show();
      return;
    }

    token = localStorage.getItem("jwt_token")

    const requestData = {
      client_name: name,
      client_contact: phone,
      appointment_date: appointmentDateTime,
      barber_id: parseInt(barberId),
      service_id: parseInt(serviceId),
    };

    fetch("/createAppointment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(requestData)
    })
            .then(response => {
              if (response.status === 201) {
                return response.json().then(data => {
                  showAlert("Agendamento realizado com sucesso!","success");
                  setTimeout(() => {
                    window.location.reload(true);
                  }, 3000);
                });
              } else {
                return response.json().then(data => {
                  showAlert(`Erro: ${data.message || "Não foi possível agendar o horário."}`);
                  setTimeout(() => {
                    window.location.reload(true);
                  }, 3000);
                });
              }
            })
            .catch(error => {
              console.error("Erro ao agendar:", error);
              showAlert("Ocorreu um erro ao tentar agendar. Por favor, tente novamente.",error);
            });
  });

  function formatPhoneNumberAppointment() {
    var phoneInput = document.getElementById('phone');
    var myForm = document.forms.myForm;
    var result = document.getElementById('result');

    phoneInput.addEventListener('input', function (e) {
      var x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
      e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
    });


    myForm.addEventListener('submit', function(e) {

      phoneInput.value = phoneInput.value.replace(/\D/g, '');
      result.innerText = phoneInput.value;

      e.preventDefault();
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    formatPhoneNumberAppointment();
  });

</script>

<style>

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #availableSlots::-webkit-scrollbar {
    height: 1rem;
  }

  #availableSlots::-webkit-scrollbar-thumb {
    background-color: #146c43;
    border-radius: 4px;
  }

  #availableSlots::-webkit-scrollbar-track {
    background-color: #DDDBDB;
  }
  html, body {
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
  }
</style>

</html>